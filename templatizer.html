<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="templatizer-factory.html">

<script>
  // Transformation for v2
  if (Polymer.Templatizer instanceof Function) {
    Polymer.Templatizer = {
      factory: new Polymer.TemplatizerFactory(),

      _instanceProps: {},

      _userTemplate: null,

      __ctor: null,

      templatize: function(template) {
        this.__ctor = Polymer.Templatizer.factory.templatize(template, {
          instanceProps: this._instanceProps,
          fwdHostPropToInstance: this._fwdHostPropToInstance.bind(this),
          fwdInstancePropToHost: this._fwdInstancePropToHost.bind(this)
        });
      },

      stamp: function(props) {
        return new this.__ctor(this, props);
      },

      _fwdHostPropToInstance: function(template, prop, value) {
      },

      _fwdInstancePropToHost: function(inst, prop, value) {
      },

      _forwardParentProp: function(prop, value) {
      },

      _forwardParentPath: function(path, value) {
      },

      _forwardItemPath: function(path, value) {
      },

      _forwardInstancePath: function(inst, path, value) {
      },

      modelForElement: function(el) {
        Polymer.Templatizer.factory.modelForElement(this._template, el);
      },

      enqueueDebouncer: function(debouncer) {
        Polymer.TemplatizerFactory.enqueueDebouncer(debouncer);
      },

      flush: function() {
        Polymer.TemplatizerFactory.flush();
      }
    };
  } else {
    Polymer.Templatizer.templatize = function(template) {
      this._templatized = template;
      // TODO(sjmiles): supply _alternate_ content reference missing from root
      // templates (not nested). `_content` exists to provide content sharing
      // for nested templates.
      if (!template._content) {
        template._content = template.content;
      }
      // fast path if template's anonymous class has been memoized
      if (template._content._ctor) {
        this.ctor = template._content._ctor;
        //console.log('Templatizer.templatize: using memoized archetype');
        // forward parent properties to archetype
        this._prepParentProperties(this.ctor.prototype, template);
        return;
      }
      // `archetype` is the prototype of the anonymous
      // class created by the templatizer
      var archetype = Object.create(Polymer.Base);
      // normally Annotations.parseAnnotations(template) but
      // archetypes do special caching
      this._customPrepAnnotations(archetype, template);
      // forward parent properties to archetype
      this._prepParentProperties(archetype, template);
      // setup accessors
      archetype._prepEffects();
      this._customPrepEffects(archetype);
      archetype._prepBehaviors();
      archetype._prepPropertyInfo();
      archetype._prepBindings();
      // boilerplate code
      archetype._notifyPathUp = this._notifyPathUpImpl;
      archetype._scopeElementClass = this._scopeElementClassImpl;
      archetype.listen = this._listenImpl;
      archetype._showHideChildren = this._showHideChildrenImpl;
      archetype.__setPropertyOrig = this.__setProperty;
      archetype.__setProperty = this.__setPropertyImpl;

      // Similar to 2.0
      archetype.forwardProperty = this.__forwardProperty;
      archetype.flushProperties = this.__flushProperties;
      // boilerplate code
      var _constructor = this._constructorImpl;
      var ctor = function TemplateInstance(model, host) {
        _constructor.call(this, model, host);
      };
      // standard references
      ctor.prototype = archetype;
      archetype.constructor = ctor;
      // TODO(sjmiles): constructor cache?
      template._content._ctor = ctor;
      // TODO(sjmiles): choose less general name
      this.ctor = ctor;
    };

    Polymer.Templatizer.__forwardProperty = function(name, value) {
      this[name] = value;
    };

    Polymer.Templatizer.__flushProperties = function noop() {};
    Polymer.Templatizer.enqueueDebouncer = function noop() {};
    Polymer.Templatizer.flush = function noop() {};
  }
</script>